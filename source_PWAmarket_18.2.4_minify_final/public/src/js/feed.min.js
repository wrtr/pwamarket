var postButton=document.querySelector("#post-button"),createPostArea=document.querySelector("#create-post"),closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),itemsArea=document.querySelector("#items-area"),form=document.querySelector("form"),itemInput=document.querySelector("#item"),locationInput=document.querySelector("#location"),priceInput=document.querySelector("#price"),videoPlayer=document.querySelector("#player"),canvasElement=document.querySelector("#canvas"),captureButton=document.querySelector("#capture-btn"),imagePicker=document.querySelector("#image-picker"),imagePickerArea=document.querySelector("#pick-image"),picture=null,locationBtn=document.querySelector("#location-btn"),locationLoader=document.querySelector("#location-loader"),fetchedLocation={lat:0,lng:0};function initializeLocation(){"geolocation"in navigator||(locationBtn.style.display="none")}function initializeMedia(){"mediaDevices"in navigator||(navigator.mediaDevices={}),"getUserMedia"in navigator.mediaDevices||(navigator.mediaDevices.getUserMedia=function(o){var a=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return a?new Promise(function(e,t){a.call(navigator,o,e,t)}):Promise.reject(new Error("getUserMedia is not implemented!"))}),navigator.mediaDevices.getUserMedia({video:!0}).then(function(e){videoPlayer.srcObject=e,videoPlayer.style.display="block"}).catch(function(e){imagePickerArea.style.display="block"})}function openCreatePostModal(){createPostArea.style.display="block",setTimeout(function(){createPostArea.style.transform="translateY(0)"},1),initializeMedia(),initializeLocation(),deferredPrompt&&(deferredPrompt.prompt(),deferredPrompt.userChoice.then(function(e){console.log(e.outcome),"dismissed"===e.outcome?console.log("User cancelled installation"):console.log("User added to home screen")}),deferredPrompt=null)}function closeCreatePostModal(){imagePickerArea.style.display="none",videoPlayer.style.display="none",canvasElement.style.display="none",captureButton.style.display="inline",videoPlayer.srcObject&&videoPlayer.srcObject.getVideoTracks().forEach(function(e){e.stop()}),locationBtn.style.display="inline",locationLoader.style.display="none",setTimeout(function(){createPostArea.style.transform="translateY(100vh)"},1)}function clearCards(){for(;itemsArea.hasChildNodes();)itemsArea.removeChild(itemsArea.lastChild)}function createCard(e){var t=document.createElement("div");t.className="items-area-card mdl-card mdl-shadow--2dp";var o=document.createElement("div");o.className="mdl-card__title",o.style.backgroundImage="url("+e.image+")",o.style.backgroundSize="cover",o.style.height="180px",t.appendChild(o);var a=document.createElement("h2");a.style.color="HEX: #4040a14",a.className="mdl-card__title-text price",a.textContent="Price : $"+e.price,a.style.backgroundColor="#92a8d1",o.appendChild(a);var n=document.createElement("div");n.style.backgroundColor="#b2b2b2",n.style.color="#50394c",n.className="item",n.textContent="Item : "+e.item,n.style.textAlign="center",t.appendChild(n);var i=document.createElement("div");i.style.color="#618685",i.className="location",i.textContent="Location : "+e.location,i.style.textAlign="center",t.appendChild(i),componentHandler.upgradeElement(t),itemsArea.appendChild(t)}function updateUI(e){clearCards();for(var t=0;t<e.length;t++)createCard(e[t])}locationBtn.addEventListener("click",function(e){"geolocation"in navigator&&(locationBtn.style.display="none",locationLoader.style.display="block",navigator.geolocation.getCurrentPosition(function(e){locationBtn.style.display="inline",locationLoader.style.display="none",fetchedLocation={lat:e.coords.latitude,lng:e.coords.longitude},locationInput.value="lat : "+e.coords.latitude+"   |   lng : "+e.coords.longitude,document.querySelector("#location-main").classList.add("is-focused")},function(e){console.log(e),locationBtn.style.display="inline",locationLoader.style.display="none",sawAlert||(alert("Failed to get location information, please enter manually!"),sawAlert=!0),fetchedLocation={lat:0,lng:0}},{timeout:7e3}))}),captureButton.addEventListener("click",function(e){canvasElement.style.display="block",videoPlayer.style.display="none",captureButton.style.display="none",canvasElement.getContext("2d").drawImage(videoPlayer,0,0,canvas.width,videoPlayer.videoHeight/(videoPlayer.videoWidth/canvas.width)),videoPlayer.srcObject.getVideoTracks().forEach(function(e){e.stop()}),picture=dataURItoBlob(canvasElement.toDataURL())}),imagePicker.addEventListener("change",function(e){picture=e.target.files[0]}),postButton.addEventListener("click",openCreatePostModal),closeCreatePostModalButton.addEventListener("click",closeCreatePostModal);var url="https://pwamarket-acc37.firebaseio.com/posts.json",networkDataReceived=!1;function sendData(){var e=(new Date).toISOString(),t=new FormData;t.append("id",e),t.append("item",itemInput.value),t.append("location",locationInput.value),t.append("rawLocationLat",fetchedLocation.lat),t.append("rawLocationLng",fetchedLocation.lng),t.append("price",priceInput.value),t.append("file",picture,e+".png"),fetch("https://us-central1-pwamarket-acc37.cloudfunctions.net/storePostData",{method:"POST",body:t,mode:"no-cors"}).then(function(e){console.log("Sent data",e),updateUI()})}fetch(url).then(function(e){return e.json()}).then(function(e){networkDataReceived=!0,console.log("From web",e);var t=[];for(var o in e)t.push(e[o]);updateUI(t)}),"indexedDB"in window&&readAllData("posts").then(function(e){networkDataReceived||(console.log("From indexedDB store",e),updateUI(e))}),form.addEventListener("submit",function(e){e.preventDefault(),""!==itemInput.value.trim()&&""!==locationInput.value.trim()&&""!==priceInput.value.trim()&&null!==picture?(closeCreatePostModal(),"serviceWorker"in navigator&&"SyncManager"in window?navigator.serviceWorker.ready.then(function(e){var t={id:(new Date).toISOString(),item:itemInput.value,location:locationInput.value,price:priceInput.value,picture:picture,rawLocation:fetchedLocation};writeData("sync-posts",t).then(function(){return e.sync.register("sync-new-posts")}).then(function(){document.querySelector("#confirmation-toast").MaterialSnackbar.showSnackbar({message:"Your Post was saved for syncing!"})}).catch(function(e){console.log(e)})}):sendData()):alert("Please enter valid data!")});